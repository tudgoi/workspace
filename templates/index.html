{% extends "base.html" %}
{% block content %}

This is an attempt at collating the contact information and power structure of
the people who serve and govern India.

We are just starting out and this site will likely be under development for a long time,
before it becomes practically usable. If you are interested in joining, checkout
the <a href="https://github.com/arunkd13/directory-gov-in">project source code</a>.

<style>
    div.metric {
	    text-align: center;
    }
    div.search {
        margin: 2em;
        display: grid;
        place-items: center;
    }
    div.field label {
        font-weight: bold;
        margin-right: 1em;
    }
</style>

  <hr/>

  <div class="metric">
	  Tracking <b>{{ persons }}</b> persons across <b>{{ offices }}</b> offices.
    <p>
    Start with <a href="person/droupadm.html">Droupadi Murmu</a>, President of India
    </p>
  </div>

  <div class="search">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Enter your search query..." />
        <button onclick="performSearch()">Search</button>
    </div>
    <div id="status" class="status">Loading search engine...</div>
    <div id="results" class="results"></div>
  </div>

  <script>
      let wasmModule = null;
      let memory = null;
      let searchFunction = null;
      let freeFunction = null;
      
      async function initializeSearch() {
          try {
              const response = await fetch('./tinysearch_engine.wasm');
              if (!response.ok) {
                  throw new Error(`Failed to fetch WASM: ${response.status} ${response.statusText}`);
              }
              
              const wasmBytes = await response.arrayBuffer();
              const module = await WebAssembly.instantiate(wasmBytes);
              
              wasmModule = module.instance;
              memory = wasmModule.exports.memory;
              searchFunction = wasmModule.exports.search;
              freeFunction = wasmModule.exports.free_search_result;
              
              if (!searchFunction || !freeFunction || !memory) {
                  throw new Error('Required WASM exports not found');
              }
              
              document.getElementById('status').textContent = 'Search engine ready! Try entering a query above.';
              document.getElementById('searchInput').disabled = false;
              document.getElementById('searchInput').focus();
              
          } catch (error) {
              console.error('Failed to initialize search:', error);
              document.getElementById('status').innerHTML = `<div class="error">Failed to initialize search: ${error.message}</div>`;
          }
      }
      
      function stringToWasmPtr(str) {
          const bytes = new TextEncoder().encode(str + '\0');
          const ptr = wasmModule.exports.__wbindgen_malloc(bytes.length);
          if (!ptr) {
              // Fallback: write to a known memory location
              const memoryArray = new Uint8Array(memory.buffer);
              const startOffset = 1024; // Use a safe offset
              memoryArray.set(bytes, startOffset);
              return startOffset;
          }
          new Uint8Array(memory.buffer, ptr, bytes.length).set(bytes);
          return ptr;
      }
      
      function wasmPtrToString(ptr) {
          if (ptr === 0) return null;
          
          const memoryArray = new Uint8Array(memory.buffer);
          let length = 0;
          
          // Find the null terminator
          while (memoryArray[ptr + length] !== 0) {
              length++;
              if (length > 1000000) break; // Safety limit
          }
          
          const bytes = memoryArray.slice(ptr, ptr + length);
          return new TextDecoder().decode(bytes);
      }
      
      function performSearch() {
          const query = document.getElementById('searchInput').value.trim();
          const resultsDiv = document.getElementById('results');
          const statusDiv = document.getElementById('status');
          
          if (!wasmModule) {
              statusDiv.innerHTML = '<div class="error">Search engine not initialized</div>';
              return;
          }
          
          if (!query) {
              resultsDiv.innerHTML = '';
              statusDiv.textContent = 'Enter a search query to see results.';
              return;
          }
          
          try {
              const startTime = performance.now();
              
              // Allocate memory for query string
              let queryPtr;
              try {
                  queryPtr = stringToWasmPtr(query);
              } catch (e) {
                  // Fallback: use a fixed memory location
                  const queryBytes = new TextEncoder().encode(query + '\0');
                  const memoryArray = new Uint8Array(memory.buffer);
                  queryPtr = 1024; // Fixed offset
                  memoryArray.set(queryBytes, queryPtr);
              }
              
              // Call search function
              const resultPtr = searchFunction(queryPtr, 10);
              
              // Free query memory if we allocated it
              if (wasmModule.exports.__wbindgen_free && queryPtr > 1024) {
                  wasmModule.exports.__wbindgen_free(queryPtr, query.length + 1);
              }
              
              const endTime = performance.now();
              const searchTime = (endTime - startTime).toFixed(3);
              
              if (resultPtr === 0) {
                  resultsDiv.innerHTML = '<div class="no-results">No results found</div>';
                  statusDiv.textContent = `No results found for "${query}" (${searchTime}ms)`;
                  return;
              }
              
              // Read result string
              const resultString = wasmPtrToString(resultPtr);
              
              // Free result memory
              freeFunction(resultPtr);
              
              if (!resultString) {
                  resultsDiv.innerHTML = '<div class="no-results">No results found</div>';
                  statusDiv.textContent = `No results found for "${query}" (${searchTime}ms)`;
                  return;
              }
              
              const results = JSON.parse(resultString);
              
              if (results.length === 0) {
                  resultsDiv.innerHTML = '<div class="no-results">No results found</div>';
                  statusDiv.textContent = `No results found for "${query}" (${searchTime}ms)`;
              } else {
                  const resultHTML = results.map(result => `
                      <div class="result-item">
                          <a href="${result.url}" class="result-title" target="_blank">${result.title}</a>
                      </div>
                  `).join('');
                  
                  resultsDiv.innerHTML = resultHTML;
                  statusDiv.textContent = `Found ${results.length} result${results.length !== 1 ? 's' : ''} for "${query}" (${searchTime}ms)`;
              }
              
          } catch (error) {
              console.error('Search error:', error);
              resultsDiv.innerHTML = '<div class="error">Search failed. Check console for details.</div>';
              statusDiv.innerHTML = `<div class="error">Search failed: ${error.message}</div>`;
          }
      }
        
        // Enter key support
        document.getElementById('searchInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        });
        
        // Initialize search engine
        document.getElementById('searchInput').disabled = true;
        initializeSearch();
    </script>

{% endblock content %}

